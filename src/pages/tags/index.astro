---
import { getCollection } from "astro:content";
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPost from "../../components/BlogPost.astro";
import { basePath } from "../../config";

//get all posts
const allPosts = await getCollection("blog");
//filter out drafts
const publishedPosts = allPosts.filter(post => !post.data.draft);

// Group posts by tag
const postsByTag = new Map();

for (const post of publishedPosts) {
  const tags = post.data.tags || [];
  for (const tag of tags) {
    if (!postsByTag.has(tag)) {
      postsByTag.set(tag, []);
    }
    postsByTag.get(tag).push(post);
  }
}

// Convert map to array and sort alphabetically by tag name
const sortedTags = Array.from(postsByTag.entries()).sort((a, b) => a[0].localeCompare(b[0]));

const pageTitle = "Tag Index";
---

<BaseLayout pageTitle={pageTitle} isBlogPost={true}>
    <div class="restricted-width">
        {sortedTags.map(([tag, posts]) => (
            <details>
                <summary>{tag} ({posts.length})</summary>
                <div class="content">
                    <ul>
                        {posts.map((post) => (
                            <BlogPost 
                                url={`${basePath}posts/${post.id}/`} 
                                title={post.data.title} 
                                author={post.data.author}
                                tags={post.data.tags}
                            />
                        ))}
                    </ul>
                </div>
            </details>
        ))}
    </div>
</BaseLayout>
